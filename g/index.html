<!DOCTYPE html>
<!--[if lt IE 7]><html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]><html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html> <!--<![endif]-->
	<head>
		<title>Idescat Visual</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<!-- <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> -->
		<meta charset="utf-8" />

		<link href="../visual.css" rel="stylesheet" type="text/css" />
		<script src="../lib/lazyload.js"></script>
		<script src="../visual.js"></script>
		<script src="../visual.setup.js"></script>

		<script type='text/javascript' src='../lib/jquery.1.8.3.js'></script>

	</head>
	
	<body>
		<div id="visual" class="visual"></div>
		<script>

		function getParam(name) {
			name=name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var 
				regex=new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results=regex.exec(location.search)
			;
			return (results===null) ? "" : decodeURIComponent( results[1].replace(/\+/g, " ") );
		}

		function msg(s){
			$("#visual").html(s);
		}

		function isVisual(s){
			var json=JSON.parse( s );
			if(json!==null && json.data && json.type){ //.data & .type are required fields in Visual
				return json;
			}
			return null;
		}

		function cache(k,v){
			if(window.localStorage) {
				localStorage.setItem("Visual"+k, v);
			}
		}

		function visualize(json, id, source){
			if(json){
				visual(json);
				if(!source){
					log("Retrieved from localStorage.");
				}else{
					cache(id, source);
				}
			}else{
				if(!source){
					msg("This cached id ("+id+") does not contain valid Visual content.");
				}else{
					msg("The specified id ("+id+") does not contain valid Visual content.");
					cache(id, "");
				}
			}
		}

		function getJSON(id) {
			if( window.localStorage && localStorage.getItem("Visual"+id) ) {
				var json=isVisual( localStorage.getItem("Visual"+id) );
				visualize(json, id, null);
			}else{
				$.get('https://api.github.com/gists/' + id,
				function(data, status, xhr) {
					var json, src;
					if(data.description==="Idescat Visual"){
						var source=data.files["source.json"];
						if(source.type==="application/json"){
							src=source.content;
							json=isVisual(src);
						}
					}

					visualize(json, id, src);
					log("Remaining this hour: " + xhr.getResponseHeader("X-RateLimit-Remaining"));
				}).fail(function(xhr, status, errorThrown) {
					msg("No saved information could be fetched for id="+id+"!");
					log("Error fetching anonymous gist!");
					log(xhr);
					log(status);
					log(errorThrown);
				});
			}
		}

		function log(s){
			window.console && console.log(s);
		}

		var id=getParam("id");
		if(id){
			getJSON(id);
		}else{
			msg('You need to specify an id. For example: <a href="?id=38a211aff4d3a062b305">38a211aff4d3a062b305</a>. Or use the <a href="http://idescat.github.io/visual/">Visual Maker</a> to generate a new one.');
		}
		</script>
	</body>
</html>
