<!DOCTYPE html>
<!--[if lt IE 7]><html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]><html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html> <!--<![endif]-->
	<head>
		<title>Idescat Visual</title>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<link rel="shortcut icon" href="https://www.idescat.cat/images/favicon.ico" type="image/x-icon" />
		<link href="../visual.css" rel="stylesheet" type="text/css" />
		<script src="../lazyvisualsetup.js"></script>
		<script type='text/javascript' src='../lib/jquery.1.8.3.js'></script>

		<style type="text/css">
			p.msg {
				font-size: 1.4em;
				margin: 2em;
				line-height: 1.4;
				background-color: #eee;
				padding: 1em;
			}
		</style>
	</head>

	<body>
		<div id="visual" class="visual"></div>
		<script>

		function getParam(name) {
			name=name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var
				regex=new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results=regex.exec(location.search)
			;
			return (results===null) ? "" : decodeURIComponent( results[1].replace(/\+/g, " ") );
		}

		function msg(s){
			$("#visual").html('<p class="msg">'+s+"</p>");
		}

		function isVisual(s){
			var json=JSON.parse( s );
			if(json!==null && json.data && json.type){ //.data & .type are required fields in Visual
				return json;
			}
			return null;
		}

		function cache(k,v){
			if(window.localStorage) {
				localStorage.setItem("Visual"+k, v);
			}
		}

		function visualize(json, id, source){
			if(json){
				visual(json);
				if(!source){
					log("Retrieved from localStorage.");
				}else{
					cache(id, source);
				}
			}else{
				if(!source){
					msg("This cached id ("+id+") does not contain valid Visual content.");
				}else{
					msg("The specified id ("+id+") does not contain valid Visual content.");
					cache(id, "");
				}
			}
		}

		function getJSON(id) {
			var
				json,
				vid="Visual"+id
			;

			if( window.localStorage && localStorage.getItem(vid) ) {
				json=isVisual( localStorage.getItem(vid) );
				visualize(json, id, null);
			}else{
				$.get(
					"https://api.github.com/gists/" + id,
					function(data) {
						var
							src,
							source,
							d=data.data,
							meta=data.meta,
							quota=meta["X-RateLimit-Remaining"],
							desc=d.description
						;

						log("Remaining this hour: " + quota + " charts.");

						if(meta.status===403){ //Forbidden
							//Do not show anything on screen
							log("Exceeded rate limit? Try later.");
							log(meta.status);
							log(d.message);
							return;
						}

						if(meta.status!==200){
							msg("No saved information could be fetched for id="+id+"!");
							log(meta.status);
							log(d.message);
							return;
						}

						if(desc.substr(0,8)==="Visual: " || desc==="Idescat Visual"){
							if(d.files.hasOwnProperty("source.json")){
								source=d.files["source.json"];
								if(source.type==="application/json"){
									src=source.content;
									json=isVisual(src);
								}
							}
						}
						visualize(json, id, src);
					},
					"jsonp"
				);
			}
		}

		function log(s){
			window.console && console.log(s);
		}

		var id=getParam("id");
		if(id){
			getJSON(id);
		}else{
			msg('You need to specify an id. For example: <a href="?id=4373b81b8b12988a91bc">4373b81b8b12988a91bc</a>. Or use the <a href="//idescat.github.io/visual/">Visual Maker</a> to generate a new one.');
		}

		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-26838309-1', 'auto');
		ga('send', 'pageview');

		</script>
	</body>
</html>
